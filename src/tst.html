<!DOCTYPE html>
<html lang="fa" dir="rtl">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>سامانه پاکت‌های مالی — نسخه شخصی</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body
        class="min-h-screen bg-gradient-to-b from-[#031028] to-[#071428] text-slate-200 font-[Vazirmatn]"
    >
        <div class="max-w-4xl mx-auto mt-7 p-5">
            <!-- Header -->
            <header
                class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
            >
                <div>
                    <h1 class="text-lg font-bold">
                        سامانه پاکت‌های مالی — نسخه شخصی تو
                    </h1>
                    <div class="text-sm text-slate-400">
                        ساده، کاربرپسند و آفلاین — همه‌چیز در مرورگرت ذخیره
                        می‌شود.
                    </div>
                </div>
                <div
                    class="bg-white/5 px-3 py-1 rounded-full font-semibold text-sm"
                >
                    درآمد پیش‌فرض:
                    <span id="displayIncome">7,000,000</span> تومان
                </div>
            </header>

            <!-- Main Card -->
            <div
                class="bg-white/5 backdrop-blur-sm rounded-xl shadow-lg p-4 mt-5"
            >
                <!-- Inputs Row -->
                <div class="flex flex-col md:flex-row gap-3">
                    <div class="flex-1">
                        <label class="block text-sm mb-2"
                            >درآمد ماهیانه (تومان)</label
                        >
                        <input
                            id="incomeInput"
                            type="number"
                            value="7000000"
                            class="w-full rounded-lg border border-white/10 bg-transparent px-3 py-2 text-slate-200"
                        />
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm mb-2"
                            >هدف موتور (تومان)</label
                        >
                        <input
                            id="goalInput"
                            type="number"
                            value="90000000"
                            class="w-full rounded-lg border border-white/10 bg-transparent px-3 py-2 text-slate-200"
                        />
                    </div>
                    <div class="min-w-[160px] flex flex-col justify-end gap-2">
                        <button
                            id="applyBtn"
                            class="bg-blue-400 text-[#042342] font-semibold rounded-lg px-3 py-2"
                        >
                            اعمال تقسیم‌بندی
                        </button>
                        <button
                            id="resetBtn"
                            class="bg-rose-400 text-white font-semibold rounded-lg px-3 py-2"
                        >
                            تنظیم مجدد
                        </button>
                    </div>
                </div>

                <!-- Alert -->
                <div
                    class="bg-white/5 rounded-lg p-3 mt-3 text-sm text-slate-400"
                >
                    الگوی فعلی: <strong>اول به خودت پرداخت کن</strong> — مقدار
                    پیش‌فرض پس‌انداز: ۱,۵۰۰,۰۰۰ تومان؛ باشگاه ثابت: ۱,۰۰۰,۰۰۰
                    تومان.
                </div>

                <!-- Envelopes -->
                <div
                    id="envelopes"
                    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mt-4"
                ></div>

                <!-- Progress -->
                <div
                    class="flex flex-col md:flex-row justify-between items-start md:items-center mt-4 gap-3"
                >
                    <div>
                        <label class="block text-sm mb-2">ثبت خرج جدید</label>
                        <div class="flex gap-2">
                            <select
                                id="expEnv"
                                class="rounded-lg border border-white/10 bg-transparent px-3 py-2 text-slate-200"
                            >
                                <option value="savings">پس‌انداز</option>
                                <option value="gym">باشگاه</option>
                                <option value="needs">نیازها</option>
                                <option value="wants">خواسته‌ها</option>
                            </select>
                            <input
                                id="expAmount"
                                type="number"
                                placeholder="مبلغ (تومان)"
                                class="rounded-lg border border-white/10 bg-transparent px-3 py-2 text-slate-200"
                            />
                            <button
                                id="addExpBtn"
                                class="bg-blue-400 text-[#042342] font-semibold rounded-lg px-3 py-2"
                            >
                                ثبت خرج
                            </button>
                        </div>
                    </div>
                    <div class="text-left w-full md:w-auto">
                        <div class="text-sm text-slate-400 mb-1">
                            پیشرفت به هدف موتور:
                        </div>
                        <div
                            class="w-full md:w-[300px] h-2 bg-white/10 rounded-lg overflow-hidden"
                        >
                            <div
                                id="goalFill"
                                class="h-full rounded-lg transition-all bg-gradient-to-r from-blue-400 to-green-400"
                                style="width: 0%"
                            ></div>
                        </div>
                        <div id="goalText" class="text-sm text-slate-400 mt-1">
                            0 / 90,000,000
                        </div>
                    </div>
                </div>
            </div>

            <!-- Savings Total -->
            <div
                class="bg-white/5 backdrop-blur-sm rounded-xl shadow-lg p-4 mt-3 flex items-center justify-between"
            >
                <div>
                    <div class="text-sm text-slate-400">
                        مجموع پس‌انداز فعلی:
                    </div>
                    <div id="savingsTotal" class="text-lg font-bold">
                        0 تومان
                    </div>
                </div>
                <div>
                    <button
                        id="exportBtn"
                        class="bg-blue-400 text-[#042342] font-semibold rounded-lg px-3 py-2"
                    >
                        دریافت گزارش اکسل
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <footer class="mt-4 text-center text-sm text-slate-400">
                این وب‌اپ کاملاً آفلاین است. داده‌ها در مرورگرت ذخیره می‌شوند.
                برای پاک‌کردن، از دکمه تنظیم مجدد استفاده کن.
            </footer>
        </div>

        <script>
            // Data model with default split
            const DEFAULT = {
                income: 7000000,
                goal: 90000000,
                split: {
                    savings: 1500000,
                    gym: 1000000,
                    needs: 3500000,
                    wants: 1000000,
                },
                balances: {
                    savings: 1500000,
                    gym: 1000000,
                    needs: 3500000,
                    wants: 1000000,
                },
                cumulativeSavings: 0,
            };
            let state = load() || structuredClone(DEFAULT);

            // DOM
            const envelopesEl = document.getElementById("envelopes");
            const incomeInput = document.getElementById("incomeInput");
            const goalInput = document.getElementById("goalInput");
            const applyBtn = document.getElementById("applyBtn");
            const resetBtn = document.getElementById("resetBtn");
            const displayIncome = document.getElementById("displayIncome");
            const expEnv = document.getElementById("expEnv");
            const expAmount = document.getElementById("expAmount");
            const addExpBtn = document.getElementById("addExpBtn");
            const goalFill = document.getElementById("goalFill");
            const goalText = document.getElementById("goalText");
            const savingsTotal = document.getElementById("savingsTotal");
            const exportBtn = document.getElementById("exportBtn");

            function labelOf(k) {
                return {
                    savings: "پس‌انداز",
                    gym: "باشگاه",
                    needs: "نیازها",
                    wants: "خواسته‌ها",
                }[k];
            }
            function colorOf(k) {
                return {
                    savings: "bg-gradient-to-r from-blue-400 to-green-400",
                    gym: "bg-yellow-500",
                    needs: "bg-blue-400",
                    wants: "bg-purple-400",
                }[k];
            }
            function formatNumber(n) {
                return (
                    n?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") || "0"
                );
            }

            function renderEnvelopes() {
                envelopesEl.innerHTML = "";
                for (const key of ["savings", "gym", "needs", "wants"]) {
                    const bal = state.balances[key];
                    const total = state.split[key];
                    const pct = Math.min(100, Math.round((bal / total) * 100));
                    const card = document.createElement("div");
                    card.className =
                        "env bg-white/5 backdrop-blur-sm border border-white/10 rounded-xl p-3";
                    card.innerHTML = `
            <h3 class="text-sm font-semibold mb-1">${labelOf(key)}</h3>
            <div class="text-xs text-slate-400 mb-2">${formatNumber(
                bal
            )} / ${formatNumber(total)} تومان</div>
            <div class="w-full h-2 bg-white/10 rounded-lg overflow-hidden mb-2">
              <div class="h-full rounded-lg transition-all ${colorOf(
                  key
              )}" style="width:${pct}%"></div>
            </div>
            <div class="flex gap-2">
              <button class="good bg-green-400 text-[#042342] font-semibold rounded-lg px-2 py-1 text-xs" data-key="${key}">افزایش</button>
              <button class="danger bg-rose-400 text-white font-semibold rounded-lg px-2 py-1 text-xs" data-key="${key}---dec">کاهش</button>
            </div>
          `;
                    envelopesEl.appendChild(card);
                }
                displayIncome.textContent = formatNumber(state.income);
                goalText.textContent =
                    formatNumber(state.cumulativeSavings) +
                    " / " +
                    formatNumber(state.goal);
                const progress = Math.min(
                    100,
                    Math.round((state.cumulativeSavings / state.goal) * 100)
                );
                goalFill.style.width = progress + "%";
                savingsTotal.textContent =
                    formatNumber(state.cumulativeSavings) + " تومان";

                document.querySelectorAll(".env button").forEach((b) =>
                    b.addEventListener("click", (e) => {
                        const k = e.currentTarget.getAttribute("data-key");
                        if (k.endsWith("---dec")) {
                            const key = k.split("---")[0];
                            const amt = prompt(
                                "مقدار برای کاهش از " +
                                    labelOf(key) +
                                    " (تومان) را وارد کن:",
                                "100000"
                            );
                            if (!amt) return;
                            changeBalance(key, -Math.abs(parseInt(amt)));
                        } else {
                            const key = k;
                            const amt = prompt(
                                "مقدار برای افزایش " +
                                    labelOf(key) +
                                    " (تومان) را وارد کن:",
                                "100000"
                            );
                            if (!amt) return;
                            changeBalance(key, Math.abs(parseInt(amt)));
                        }
                    })
                );
            }

            function changeBalance(key, delta) {
                state.balances[key] = Math.max(0, state.balances[key] + delta);
                if (key === "savings" && delta > 0)
                    state.cumulativeSavings += delta;
                save();
                renderEnvelopes();
            }

            function applySplit() {
                const inc = Math.max(
                    0,
                    parseInt(incomeInput.value) || DEFAULT.income
                );
                state.income = inc;
                const goalVal = Math.max(
                    0,
                    parseInt(goalInput.value) || DEFAULT.goal
                );
                state.goal = goalVal;
                const gym = 1000000;
                const savings = Math.max(Math.round(inc * 0.2), 1500000);
                const rest = inc - gym - savings;
                const needs = Math.max(Math.round(rest * 0.77), 1000000);
                const wants = Math.max(0, inc - gym - savings - needs);
                state.split = { savings, gym, needs, wants };
                state.balances = { ...state.split };
                save();
                renderEnvelopes();
            }

            applyBtn.addEventListener("click", applySplit);
            resetBtn.addEventListener("click", () => {
                if (confirm("آیا از پاک کردن داده‌های ذخیره‌شده مطمئنی؟")) {
                    localStorage.removeItem("pb_state");
                    state = structuredClone(DEFAULT);
                    save();
                    renderEnvelopes();
                }
            });

            addExpBtn.addEventListener("click", () => {
                const key = expEnv.value;
                const amt = parseInt(expAmount.value);
                if (!amt || amt <= 0) {
                    alert("مبلغ معتبر وارد کن");
                    return;
                }
                if (key === "savings") {
                    state.cumulativeSavings += amt;
                    state.balances.savings += amt;
                } else {
                    state.balances[key] = Math.max(
                        0,
                        state.balances[key] - amt
                    );
                }
                expAmount.value = "";
                save();
                renderEnvelopes();
            });

            exportBtn.addEventListener("click", () => {
                const rows = [["قطعه", "مقدار (تومان)"]];
                for (const k of ["savings", "gym", "needs", "wants"])
                    rows.push([labelOf(k), state.balances[k]]);
                rows.push(["جمع پس‌انداز کل", state.cumulativeSavings]);
                rows.push(["هدف موتور", state.goal]);
                const csv = rows
                    .map((r) => r.map((c) => `"${c}"`).join(","))
                    .join("\n");
                const blob = new Blob([csv], {
                    type: "text/csv;charset=utf-8;",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "budget_report.csv";
                a.click();
            });

            function save() {
                localStorage.setItem("pb_state", JSON.stringify(state));
            }
            function load() {
                try {
                    return JSON.parse(localStorage.getItem("pb_state"));
                } catch (e) {
                    return null;
                }
            }

            renderEnvelopes();
        </script>
    </body>
</html>
